## 幂等表

### 流程

<img src="..\..\picture service\类库\幂等\幂等表.png">

- 调用放发起请求，请求到达服务提供方

- 获取指定的业务key作为唯一的幂等键，构建幂等记录（此时幂等记录status为处理中（`processing`）），然后尝试将幂等记录写入存储介质（可以是Redis也可以是MySQL或其他存储介质）

- 如果幂等记录写入成功，则执行业务逻辑

- 业务逻辑执行完毕，通过唯一键修改幂等记录的status为成功（`success`）

- 如果幂等记录写入失败，则说明幂等记录已存在（该业务key对应的数据，之前有被执行过），需要进行如下处理：

- 通过幂等唯一键查询幂等记录，并且判定幂等记录的status
  
  0. 如果status为成功（`success`），则说明上次已经执行过该业务了，本次无需再重复执行，获取上次执行的结果（如果有需要的话）幂等返回即可
  
  1. 如果status为处理中（`processing`），则说明已经有其他线程正在处理业务数据 或者是 极端情况下应用宕机导致的异常情况。此时需要判定【`请求处于处理中（processing）状态的时长`】，并且结合应用配置的【`允许的最大业务执行时长`】进行判断
     
     - 处于`processing`状态的时间已经超过配置的【`允许的最大业务执行时长`】，则尝试以**乐观锁**的方式重新修改幂等记录，如果修改成功则执行业务逻辑，反之则抛出并发异常。
     - 处于`processing`状态的时间没有超过配置的【`允许的最大业务执行时长`】，那么直接抛出并发请求异常

### 问题点

**关于上述的幂等实现流程中，极端情况下，有如下几点需要思考和注意的问题点**

- 极端情况下，如果插入幂等记录成功，并且正常执行了业务流程，此时更新幂等状态为success时出现异常（比如存储幂等记录的存储介质宕机了），此时是否需要处理该异常，还是说抛出异常中断流程？？？如果抛出异常会有什么影响？如果catch异常会有什么影响？
  
  - 方案一、抛出异常：如果抛出异常中断流程，那么调用方应该感知到调用失败了，但是实际上业务流程已经执行完毕，这种情况如果调用方发起重试，那么幂等便会失效（同一个业务code被执行了两次）
  - 方案二、不抛出异常：如果不抛出异常，接口会继续执行，然后返回数据给调用方，如果调用方收到了返回数据，那么便不会发起重试了，不会有幂等问题。但是此时幂等记录的状态仍然是处理中（`processing`），再指定了`业务最大执行时间`的情况下，如果调用方【`超过指定的最大执行`】时间再次发起重试，那么幂等仍然失效（当然我们可以不指定业务最大执行时间）
  - 经过上述两种情况的比较，我们一般倾向第二种方案，自己处理掉异常，并且做一层 **【兜底策略】** （比如告警或记录该条幂等数据信息等，后续可以转人工核对该数据），这种方案更加稳定和适用

- 如果业务逻辑执行失败，那么是否应该删除之前创建的幂等记录？
  
  - 按照严格的幂等含义来说，我们应该保留这条幂等记录，并且将幂等记录的状态修改为`Exception或failed`，后续有重试请求进来时执行返回failed给调用方即可（保证多次调用得到的结果相同）。
    
    - 但是在真实环境中业务执行异常有可能是数据校验失败、接口里调用外部系统失败（比如外部系统正在发版（没有做优雅发布）等）
    - 针对于这些情况可能调用方修改数据后进行重试或过一定时间后进行重试，那么此时最好有一定的自愈能力，而不是每次这种数据都转人工处理（一些场景中会加大人力成本，比如我之前涉及到的某个系统，经常有些调用方传递的业务参数有问题或接口里调用外部系统失败的情况）
    - 当然这两种策略需要根据具体的情况来选择，没有谁好谁坏之分。

- 是否需要设定【最大的处理时间】，比如我们期望接口最大处理时间为1小时（也就是说幂等记录处理processing状态的时间最大为1h），如果超过这个时间，那么认为这不是一种正常的case，下次重试请求时应该尝试恢复业务执行。
  
  - 这也是个具有两面性的选择问题，需要根据实际项目情况权衡选择


